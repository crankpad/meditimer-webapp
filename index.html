<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Medikamenten-Timer</title>
  <meta name="theme-color" content="#4CAF50">
  <style>
    :root {
      --bg: #f9f9f9;
      --text: #000;
      --card: #fff;
      --accent: #4CAF50;
    }
    [data-theme="dark"] {
      --bg: #121212;
      --text: #ffffff;
      --card: #1e1e1e;
      --accent: #81c784;
    }
    * {
      box-sizing: border-box;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 1.5rem;
      margin: 0;
      background-color: var(--bg);
      color: var(--text);
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .container {
      width: 100%;
      max-width: 500px;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    h2, h3 {
      text-align: center;
    }
    button, input[type="time"], input[type="number"] {
      width: 100%;
      padding: 0.75rem;
      font-size: 1rem;
      border: none;
      border-radius: 8px;
      background-color: var(--accent);
      color: white;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    button:hover {
      background-color: #388e3c;
    }
    input[type="time"], input[type="number"] {
      background-color: var(--card);
      color: var(--text);
      border: 1px solid #ccc;
    }
    #output, #historyLog {
      padding: 1rem;
      background-color: var(--card);
      border-radius: 8px;
      border: 1px solid #ccc;
      white-space: pre-wrap;
    }
    #feverChart {
      width: 100%;
      height: 200px;
      background: var(--card);
      border-radius: 8px;
      border: 1px solid #ccc;
    }
    .hiddenTextArea {
      position: absolute;
      left: -9999px;
      top: -9999px;
    }
    .dark-toggle {
      position: fixed;
      bottom: 1rem;
      right: 1rem;
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background-color: var(--accent);
      color: white;
      border: none;
      font-size: 1.2rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      z-index: 1000;
    }
    #dropZone {
      border: 2px dashed #ccc;
      padding: 1rem;
      text-align: center;
      border-radius: 8px;
      margin-top: 1rem;
      color: #888;
    }
    @media (max-width: 600px) {
      body {
        padding: 1rem;
      }
      button, input {
        font-size: 1rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Medikamenten-Timer</h2>

    <label for="time">Manuelle Zeit (optional):</label>
    <input type="time" id="time">

    <button onclick="handleMed('Ibuprofen')">Ibuprofen genommen</button>
    <button onclick="handleMed('Paracetamol')">Paracetamol genommen</button>

    <div id="output" style="display:none;"></div>
    <textarea class="hiddenTextArea" id="hiddenTextArea"></textarea>
    <button onclick="copyToClipboard()">Text kopieren</button>

    <hr>
    <h3>Fieber erfassen</h3>
    <input type="number" step="0.1" min="34" max="44" id="feverInput" placeholder="Temperatur in Â°C">
    <button onclick="logFever()">Fieber speichern</button>
    <canvas id="feverChart"></canvas>
    <div id="historyLog"></div>

    <button onclick="exportData()">Fieberdaten exportieren</button>
    <button onclick="document.getElementById('fileInput').click()">Fieberdaten importieren</button>
    <input type="file" id="fileInput" accept=".txt" style="display:none" onchange="importData(event)">
    <div id="dropZone" ondrop="dropImport(event)" ondragover="event.preventDefault()">oder Datei hierher ziehen zum Importieren</div>
  </div>

  <button class="dark-toggle" onclick="toggleDarkMode()">ðŸŒ“</button>

  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.getRegistrations().then(function(registrations) {
        for(let registration of registrations) {
          registration.unregister();
        }
      });
    }

    let latestMessage = "";
    const MEDS = { Ibuprofen: 6, Paracetamol: 3 };
    let feverData = JSON.parse(localStorage.getItem('feverData')) || [];

    function format(d) {
      return d.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
    }

    function handleMed(med) {
      let now = new Date();
      const input = document.getElementById("time").value;
      if (input) {
        const [h, m] = input.split(":");
        now.setHours(parseInt(h));
        now.setMinutes(parseInt(m));
        now.setSeconds(0);
      }

      const other = med === "Ibuprofen" ? "Paracetamol" : "Ibuprofen";
      const medTime = new Date(now.getTime() + MEDS[med] * 3600000);
      const otherTime = new Date(now.getTime() + MEDS[other] * 3600000);
      const nextMed = medTime < otherTime ? med : other;
      const nextTime = nextMed === med ? medTime : otherTime;

      latestMessage =
        `${med} wurde um ${format(now)} eingenommen.

` +
        `NÃ¤chste Einnahme: ${nextMed} ab ${format(nextTime)}

` +
        `Alle Einnahmezeiten:
- ${med}: ab ${format(medTime)}
- ${other}: ab ${format(otherTime)}`;

      document.getElementById("output").textContent = latestMessage;
      document.getElementById("output").style.display = "block";
      saveLog(latestMessage);
    }

    function copyToClipboard() {
      const textarea = document.getElementById("hiddenTextArea");
      textarea.value = latestMessage;
      textarea.select();
      textarea.setSelectionRange(0, 99999);
      document.execCommand("copy");
      alert("Text kopiert!");
    }

    function logFever() {
      const val = parseFloat(document.getElementById("feverInput").value);
      if (!val || val < 34 || val > 44) return alert("UngÃ¼ltige Temperatur");
      const now = new Date();
      feverData.push([now.toISOString(), val]);
      localStorage.setItem("feverData", JSON.stringify(feverData));
      drawChart();
      saveLog(`Fieber gemessen: ${val}Â°C um ${format(now)}`);
      if (val >= 39.5) alert("Fieber Ã¼ber 39,5Â°C â€“ Medikamenteneinnahme empfohlen!");
    }

    function drawChart() {
      const canvas = document.getElementById("feverChart");
      const ctx = canvas.getContext("2d");
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      if (feverData.length < 2) return;
      const width = canvas.width;
      const height = canvas.height;
      const times = feverData.map(e => new Date(e[0]).getTime());
      const temps = feverData.map(e => e[1]);
      const minTime = Math.min(...times);
      const maxTime = Math.max(...times);
      const minTemp = Math.min(...temps, 34);
      const maxTemp = Math.max(...temps, 41);
      ctx.beginPath();
      ctx.strokeStyle = "red";
      ctx.lineWidth = 2;
      feverData.forEach((entry, i) => {
        const x = ((new Date(entry[0]).getTime() - minTime) / (maxTime - minTime)) * width;
        const y = height - ((entry[1] - minTemp) / (maxTemp - minTemp)) * height;
        i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
      });
      ctx.stroke();
    }

    function saveLog(text) {
      const div = document.getElementById("historyLog");
      const p = document.createElement("div");
      p.textContent = text;
      div.prepend(p);
    }

    function toggleDarkMode() {
      const current = document.documentElement.getAttribute("data-theme");
      document.documentElement.setAttribute("data-theme", current === "dark" ? "light" : "dark");
    }

    function exportData() {
      const data = JSON.stringify(feverData);
      const blob = new Blob([data], { type: "text/plain" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "feverdata.txt";
      a.click();
      URL.revokeObjectURL(url);
    }

    function importData(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = e => {
        try {
          const data = JSON.parse(e.target.result);
          if (Array.isArray(data)) {
            feverData = data;
            localStorage.setItem("feverData", JSON.stringify(feverData));
            drawChart();
            alert("Import erfolgreich.");
          }
        } catch (e) {
          alert("Fehler beim Importieren der Datei.");
        }
      };
      reader.readAsText(file);
    }

    function dropImport(event) {
      event.preventDefault();
      const file = event.dataTransfer.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = e => {
        try {
          const data = JSON.parse(e.target.result);
          if (Array.isArray(data)) {
            feverData = data;
            localStorage.setItem("feverData", JSON.stringify(feverData));
            drawChart();
            alert("Import erfolgreich (Drag & Drop).");
          }
        } catch (e) {
          alert("Fehler beim Drag & Drop Import.");
        }
      };
      reader.readAsText(file);
    }

    drawChart();
  </script>
</body>
</html>
